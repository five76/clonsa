Routes
~~~~~~~

Каждая сеть VPC использует масштабируемый распределенный механизм виртуальной маршрутизации. Нет физического устройства, которое было бы назначено сети. Некоторые маршруты могут применяться выборочно, но таблица маршрутизации для сети VPC определяется на уровне сети VPC.

Каждый экземпляр виртуальной машины имеет контроллер, который получает информацию обо всех применимых маршрутах из таблицы маршрутизации сети. Каждый пакет, покидающий виртуальную машину, доставляется на соответствующий следующий переход применимого маршрута на основе порядка маршрутизации. Когда вы добавляете или удаляете маршрут, набор изменений распространяется на контроллеры виртуальных машин с использованием в конечном итоге согласованной конструкции.

Системные маршруты по умолчанию
""""""""""""""""""""""""""""""""

Когда вы создаете сеть VPC, она включает в себя сгенерированный системой маршрут IPv4 по умолчанию (0.0.0.0/0). Если вы включаете внешние адреса IPv6 в подсети, в эту сеть VPC добавляется созданный системой маршрут IPv6 по умолчанию (::/0). Маршруты по умолчанию служат этим целям:

Маршрут по умолчанию IPv4 определяет путь из внешних IP-адресов сети VPC в Интернете.

Google Cloud использует маршрут по умолчанию только в том случае, если маршрут с более конкретным назначением не применяется к пакету. Дополнительные сведения о том, как специфика назначения и приоритет маршрута используются для выбора маршрута, см. в разделе Порядок маршрутизации.

Если вы хотите полностью изолировать свою сеть от Интернета или если вам нужно заменить маршрут по умолчанию пользовательским маршрутом, вы можете удалить маршрут по умолчанию:

Только IPv4: Если вы хотите перенаправить интернет-трафик на другой следующий переход, вы можете заменить маршрут по умолчанию пользовательским статическим или динамическим маршрутом. Например, вы можете заменить его пользовательским статическим маршрутом, следующим переходом которого будет виртуальная машина-прокси.

IPv4 и IPv6: Если вы удалите маршрут по умолчанию и не замените его, пакеты, предназначенные для диапазонов IP, которые не покрываются другими маршрутами, будут удалены.

Если вы удалите маршрут по умолчанию для IPv6, виртуальные машины не смогут подключаться к виртуальным машинам в других регионах, используя их адреса IPv6.

.. attention:: Если отсутствуют статические маршруты IPv4, соответствующие требованиям маршрутизации для частного доступа Google, удаление маршрута IPv4 по умолчанию может отключить частный доступ Google. Частный доступ к Google не поддерживается с IPv6-адресов.

Маршруты подсети
"""""""""""""""""""

Маршруты подсети определяют пути к ресурсам, таким как виртуальные машины и внутренние балансировщики нагрузки в сети VPC.

Каждая подсеть имеет по крайней мере один маршрут подсети, назначение которого соответствует основному диапазону IP-адресов подсети. Если подсеть имеет вторичные диапазоны IP-адресов, для каждого из ее вторичных диапазонов IP-адресов существует соответствующий маршрут подсети. 

Ни один другой маршрут не может иметь назначения, которое соответствует или является более конкретным (имеет более длинную маску подсети), чем назначение маршрута подсети.

Маршруты подсети всегда имеют наиболее конкретные пункты назначения. Они не могут быть переопределены другими маршрутами, даже если другой маршрут имеет более высокий приоритет. Это связано с тем, что при выборе маршрута Google Cloud учитывает специфику пункта назначения до приоритета. Google Cloud использует 0 в качестве приоритета для всех маршрутов подсети.

При добавлении подсети Google Cloud создает соответствующий маршрут подсети для диапазона основных IP-адресов подсети.

Если вы расширяете диапазон основных IP-адресов подсети, Google Cloud обновляет назначение соответствующего маршрута подсети.

Если вы добавляете или удаляете дополнительный диапазон IP-адресов в подсети, Google Cloud создает или уничтожает соответствующий маршрут подсети для дополнительного диапазона.

Сети VPC в автоматическом режиме создают маршрут подсети для основных диапазонов IP-адресов каждой из автоматически созданных подсетей. Вы можете удалить эти подсети, только если преобразуете сеть VPC в автоматическом режиме в пользовательский режим.

Вы не можете удалить маршрут подсети, если не измените или не удалите подсеть:

При удалении дополнительного диапазона из подсети маршрут подсети для этого дополнительного диапазона удаляется автоматически.

При удалении подсети все маршруты подсети как для основного, так и для дополнительного диапазонов удаляются автоматически. Вы не можете удалить маршрут подсети для основного диапазона подсети каким-либо другим способом.

Количество маршрутов подсети в сети VPC ограничено максимальным количеством диапазонов IP-адресов подсети (первичных и вторичных).

.. note:: Подразумеваемое правило брандмауэра "запретить вход" блокирует все входящие соединения, даже из других экземпляров в той же сети VPC. Сети VPC по умолчанию включают предварительно заполненные правила брандмауэра, включая правило входа, которое разрешает вход из источников в диапазоне 10.128.0.0/9. Для пользовательских подсетей и сетей VPC в пользовательском режиме вам потребуется создать собственные правила брандмауэра, разрешающие вход.

Статические маршруты
"""""""""""""""""""""

Статические маршруты определяются с использованием статических параметров маршрута и поддерживают следующие переходы статического маршрута. Вы можете создавать статические маршруты одним из двух способов:

Статические маршруты можно создавать вручную с помощью облачной консоли Google, gcloud compute routes create или API routes.insert.

Если вы использовали облачную консоль Google для создания классического VPN-туннеля, использующего маршрутизацию на основе политик или VPN на основе маршрутов, для вас были созданы статические маршруты для удаленных селекторов трафика. 

https://cloud.google.com/network-connectivity/docs/vpn/concepts/choosing-networks-routing

.. warning:: Для сетей VPC в автоматическом режиме не создавайте пользовательские статические маршруты, пункты назначения которых соответствуют диапазону 10.128.0.0/9. Этот диапазон содержит текущие и будущие диапазоны IP-адресов подсети для автоматически созданных подсетей. Статические маршруты с пунктами назначения внутри 10.128.0.0/9, существующие в сети в автоматическом режиме, могут быть неожиданно отключены, когда станет доступен новый регион Google Cloud. Это происходит потому, что новый маршрут подсети создается для основного диапазона IP-адресов автоматически созданной подсети нового региона. Дополнительные сведения см. в разделе Диапазоны IP-адресов в автоматическом режиме и рекомендации для сетей VPC в автоматическом режиме.

Динамические маршруты
""""""""""""""""""""""

Динамические маршруты управляются облачными маршрутизаторами в сети VPC. Их адресаты всегда представляют диапазоны IP-адресов за пределами вашей сети VPC, полученные от однорангового узла BGP. Динамические маршруты используются:

Выделенное межсоединение

Партнерское соединение

HA VPN-туннели

Классические VPN-туннели, использующие динамическую маршрутизацию

Сети VPC игнорируют все пункты назначения, полученные облачными маршрутизаторами, когда пункты назначения соответствуют любому из этих критериев:

Назначение точно соответствует диапазону IP-адресов подсети.

Адрес назначения вписывается в диапазон IP-адресов подсети (имеет более длинную маску подсети, чем).

Однако пункт назначения динамического маршрута может содержать (может иметь меньшую маску подсети, чем) диапазон IP-адресов подсети. Например, если у вас диапазон IP-адресов подсети 10.10.10.0/24, у вас может быть динамический маршрут с назначением 10.10.10.0/23. Если IP-адрес назначения пакета не соответствует назначению маршрута подсети, пакет отправляется на следующий переход динамического маршрута. Максимально широкое возможное направление - 0.0.0.0/0.

ПРименимость маршрута
~~~~~~~~~~~~~~~~~~~~~~

Созданный системой маршрут по умолчанию применяется ко всем экземплярам. Вы можете заменить созданный системой маршрут по умолчанию пользовательским статическим маршрутом, если хотите.

Пользовательские статические маршруты могут применяться ко всем экземплярам или определенным экземплярам. Статические маршруты с атрибутом тега применяются к экземплярам, имеющим тот же сетевой тег. Если у маршрута нет сетевого тега, маршрут применяется ко всем экземплярам в сети.

Когда пользовательский статический маршрут имеет экземпляр виртуальной машины следующего перехода, маршрут всегда действителен, даже если виртуальная машина следующего перехода удалена, выключена или работает неправильно.

Когда пользовательский статический маршрут имеет облачный VPN-туннель следующего перехода, маршрут всегда действителен, если туннель открыт. Дополнительные сведения о том, как Google Cloud обрабатывает маршруты для туннелей, когда они отключены, см. в разделе Когда туннели отключены в документации Cloud VPN.

Динамические маршруты применяются к экземплярам на основе режима динамической маршрутизации сети VPC. Если сеть VPC использует режим региональной динамической маршрутизации, все ее облачные маршрутизаторы создают динамические маршруты только для изученных префиксов в своем локальном регионе. Если сеть VPC использует режим глобальной динамической маршрутизации, все ее облачные маршрутизаторы создают динамические маршруты для изученных префиксов во всех регионах.
Облачные маршрутизаторы автоматически отбрасывают изученные префиксы, соответствующие недоступным следующим переходам (облачные VPN-туннели или вложения облачных соединений). В зависимости от вашей сети облачным маршрутизаторам может потребоваться до 40 секунд времени обработки, чтобы удалить динамический маршрут со следующим переходом вниз.

Для некоторого трафика с балансировкой нагрузки применимые маршруты исходят за пределы вашей сети VPC.

Порядок маршрутизации
"""""""""""""""""""""""""""

Когда экземпляр отправляет пакет, Google Cloud пытается выбрать один маршрут из набора применимых маршрутов в соответствии со следующим порядком маршрутизации.

* Маршруты подсети и маршруты пиринговой подсети рассматриваются в первую очередь, поскольку эти маршруты имеют наиболее конкретные пункты назначения. Google Cloud рассматривает маршруты пиринговых подсетей так же, как и маршруты локальных подсетей.

Если IP-адрес назначения для пакета соответствует назначению подсети или пиринговой подсети маршрута:

Пакеты доставляются на внутренний IP-адрес запущенного экземпляра виртуальной машины или настроенного внутреннего балансировщика нагрузки.

Пакеты, предназначенные для остановленного экземпляра виртуальной машины, удаляются.

Пакеты, предназначенные для внутреннего IP-адреса, удаляются, если ни один облачный ресурс Google не настроен для использования этого IP-адреса.

Google Cloud не позволяет создавать пользовательский статический маршрут, который имеет такое же или более конкретное назначение, чем любой маршрут подсети или любой маршрут пиринговой подсети.

Облачные маршрутизаторы игнорируют изученные префиксы, которые точно соответствуют назначению маршрута подсети или маршрута пиринговой подсети.

Облачные маршрутизаторы игнорируют изученные префиксы, которые соответствуют (имеют более длинную маску подсети, чем) маршруту подсети или пиринговому маршруту подсети.

* Если пакет не может быть направлен по маршруту подсети или пиринговому маршруту подсети, Google Cloud ищет статический, динамический или пользовательский пиринговый маршрут с наиболее конкретным назначением. Например, 10.240.1.0/24 является более конкретным назначением, чем 10.240.0.0/16 для пакетов с назначением 10.240.1.4.

* Если несколько маршрутов имеют один и тот же наиболее конкретный пункт назначения, Google Cloud использует следующий процесс для выбора маршрута из кандидатов на маршрут. Кандидатами на маршрут являются статические, динамические и пиринговые пользовательские маршруты, имеющие один и тот же наиболее конкретный пункт назначения.

a. Если ваша сеть VPC подключена к одноранговым сетям, Google Cloud исключает всех кандидатов на маршрут, кроме тех, которые находятся в одной сети VPC.

* Если в вашей локальной сети VPC существует один или несколько кандидатов на маршрут, Google Cloud игнорирует всех кандидатов на маршрут из одноранговых сетей.

* Если ни один из кандидатов на маршрут не существует в вашей локальной сети VPC, а вместо этого существует в нескольких одноранговых сетях, Google Cloud игнорирует всех кандидатов на маршрут, за исключением тех, которые определены в одной из одноранговых сетей. Google Cloud использует внутренний алгоритм для выбора одноранговой сети, и этот алгоритм не учитывает приоритет маршрута на данном этапе процесса. Если вы подключаетесь к новой сети или отключаетесь от существующей одноранговой сети, это может изменить выбранную Google Cloud сеть VPC.

b. Google Cloud исключает всех кандидатов на маршрут, за исключением тех, которые имеют наивысший приоритет. Если в результате останется один оставшийся маршрут, Google Cloud отправит пакет на следующий переход.

c. Если несколько кандидатов на маршрут имеют одинаковый наивысший приоритет, Google Cloud продолжит процесс исключения, используя следующий переход маршрута и тип маршрута. Если в результате останется один оставшийся маршрут, Google Cloud отправит пакет на следующий переход.

Наиболее предпочтительны пользовательские статические маршруты со следующими переходами, экземпляром следующего перехода, IP-адресом следующего перехода или VPN-туннелем следующего перехода. Все остальные кандидаты на маршрут исключаются, если существует кандидат на маршрут, использующий этот тип следующего перехода.

Пользовательские динамические маршруты являются вторыми по предпочтительности.

Пользовательские статические маршруты со следующими переходами внутренний балансировщик нагрузки TCP/UDP являются третьими по предпочтительности.

Пользовательские статические маршруты, использующие следующий переход интернет-шлюза по умолчанию, являются наименее предпочтительными.

d. Если из кандидатов на маршрут остается более одного маршрута, все эти маршруты существуют в одной и той же сети VPC, имеют одинаковый наивысший приоритет и имеют один и тот же тип маршрута или используют один и тот же тип следующего перехода. Google Cloud распределяет трафик следующим образом:

Если следующий переход не является внутренним балансировщиком нагрузки TCP/UDP, Google Cloud распределяет пакеты между следующими переходами кандидатов на маршрут, используя хэш из пяти кортежей для соответствия, реализуя многопутевую передачу с равной стоимостью (ECMP). Вычисления хэша выполняются для каждого пакета во время его отправки на основе количества кандидатов на маршрут на данном этапе. Если количество кандидатов на маршрут изменится, хэш может направить пакет с тем же хэшем из пяти кортежей на другой следующий переход.

Если следующий переход является внутренним балансировщиком нагрузки TCP/UDP, Google Cloud использует внутренний алгоритм для выбора одного балансировщика нагрузки следующего перехода, игнорируя другие следующие переходы балансировщика нагрузки, даже если они связаны с маршрутами с одинаковым приоритетом. Дополнительные сведения об этой ситуации см. в разделе Рекомендации, касающиеся следующих переходов внутреннего балансировщика нагрузки TCP/UDP.

* Если подходящее место назначения не найдено, Google Cloud отбрасывает пакет, отвечая на сообщение об ошибке назначения ICMP или недоступности сети.



