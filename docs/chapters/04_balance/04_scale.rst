Автоматическое масштабирование групп экземпляров 
====================================================

https://cloud.google.com/compute/docs/autoscaler

Выполняется путем добавления дополнительных виртуальных машин в MIG при увеличении нагрузки (масштабирование, иногда называемое увеличением масштаба) и удаления виртуальных машин при уменьшении потребности в виртуальных машинах (увеличение или уменьшение масштаба).

Технические характеристики
"""""""""""""""""""""""""""""

* Автоматическое масштабирование работает только с группами управляемых экземпляров (MIG). Неуправляемые группы экземпляров не поддерживаются.
* Если вы хотите **автоматически масштабировать** региональный MIG, применяются следующие ограничения:
- Вы должны установить для целевой формы распределения группы  **EVEN** значение.
- Для увеличения и уменьшения масштаба необходимо включить упреждающее перераспределение экземпляров ( proactive instance redistribution). Если вы настроили режим автоматического масштабирования только на scale, то вам не нужно включать упреждающее распространение экземпляров.
* Вы не можете создавать экземпляры с определенными именами, пока включено автоматическое масштабирование. Однако вы можете включить автоматическое масштабирование после создания экземпляров виртуальных машин с определенными именами.
* Вы *не можете* использовать автоматическое масштабирование, если ваш MIG имеет конфигурацию **statefull**.

* Не используйте автоматическое масштабирование Compute Engine с MIG, принадлежащими Google Kubernetes Engine. Для групп движка Google Kubernetes вместо этого используйте автоматическое масштабирование кластера.

* Средство автоматического масштабирования может принимать решения о масштабировании на основе нескольких показателей, но оно может обрабатывать только один сигнал для каждого типа показателей, за исключением показателей облачного мониторинга; средство автоматического масштабирования может обрабатывать до пяти сигналов на основе показателей мониторинга. Средство автоматического масштабирования вычисляет рекомендуемое количество виртуальных машин для каждого сигнала, а затем масштабирует на основе сигнала, который обеспечивает наибольшее количество виртуальных машин в группе.

* Автоматическое масштабирование работает независимо от autohealing. Если вы настроили автоматическое лечение для своей группы, и экземпляр не прошел проверку работоспособности, средство автоматического лечения попытается воссоздать экземпляр. Повторное создание экземпляра может привести к тому, что количество экземпляров в группе упадет ниже указанного вами порога автоматического масштабирования (MINNUMREPLICAS).

* Если вы автоматически масштабируете региональный MIG, экземпляр может быть добавлен, а затем немедленно удален из одной из зон. Это происходит, когда использование в зоне вызывает масштабирование, но общее использование в региональном MIG не требует дополнительного экземпляра или дополнительный экземпляр требуется в другой зоне.

Основы
~~~~~~~~

Автоматическое масштабирование использует следующие основные концепции и сервисы.

Группы управляемых экземпляров
"""""""""""""""""""""""""""""""""

Автоматическое масштабирование - это функция групп управляемых экземпляров (MIGS). Группа управляемых экземпляров - это коллекция экземпляров виртуальных машин (ВМ), созданных на основе общего шаблона экземпляра. Средство автоматического масштабирования добавляет или удаляет экземпляры из группы управляемых экземпляров на основе политики автоматического масштабирования группы. Хотя в Compute Engine есть как управляемые, так и неуправляемые группы экземпляров, с автомасштабером можно использовать только управляемые группы экземпляров.

Политика автоматического масштабирования
"""""""""""""""""""""""""""""""""""""""""""

Когда вы определяете политику автоматического масштабирования для своей группы, вы указываете один или несколько сигналов, которые средство автоматического масштабирования использует для масштабирования группы. Когда вы устанавливаете несколько сигналов в политике, средство автоматического масштабирования вычисляет рекомендуемое количество виртуальных машин для каждого сигнала и устанавливает рекомендуемый размер вашей группы на наибольшее число.

Целевые показатели использования
'''''''''''''''''''''''''''''''''

Вы можете автоматически масштабировать на основе одной или нескольких из следующих метрик, которые отражают нагрузку группы экземпляров:

* Средняя загрузка процессора.
* Пропускная способность балансировки нагрузки HTTP, которая может быть основана либо на использовании, либо на запросах в секунду.
* Показатели облачного мониторинга.

Средство автоматического масштабирования непрерывно собирает информацию об использовании на основе выбранной метрики использования, сравнивает фактическое использование с желаемым целевым использованием и использует эту информацию для определения того, нужно ли группе удалять экземпляры (масштабирование) или добавлять экземпляры (масштабирование).

Целевой уровень использования - это уровень, на котором вы хотите поддерживать экземпляры виртуальной машины (ВМ). Например, если вы масштабируете на основе загрузки ЦП, вы можете установить целевой уровень загрузки на уровне 75%, и средство автоматического масштабирования будет поддерживать загрузку ЦП указанной группы экземпляров на уровне или близком к 75%. Уровень использования для каждой метрики интерпретируется по-разному в зависимости от политики автоматического масштабирования.



Расписания
""""""""""""""

Вы можете использовать автоматическое масштабирование на основе расписания, чтобы распределить емкость для ожидаемых нагрузок. У вас может быть до 128 расписаний масштабирования для каждой группы экземпляров. Для каждого графика масштабирования укажите следующее:

Емкость: минимально необходимые экземпляры виртуальных машин
Расписание: время начала, продолжительность и повторяемость (например, один раз, ежедневно, еженедельно или ежемесячно)

Каждое расписание масштабирования активно с момента его запуска и в течение настроенной продолжительности. В течение этого времени autoscaler масштабирует группу, чтобы иметь по крайней мере столько экземпляров, сколько определено расписанием масштабирования.


Период охлаждения
""""""""""""""""""""

Период охлаждения также известен как период инициализации приложения. Во время инициализации приложения на экземпляре данные об использовании экземпляра могут не отражать обычные обстоятельства. Таким образом, автоскейлер использует период охлаждения для принятия решений о масштабировании следующими способами:

* Для принятия решений о масштабировании средство автоматического масштабирования учитывает данные об использовании всех экземпляров, даже экземпляра, который все еще находится в пределах периода охлаждения. Средство автоматического масштабирования рекомендует удалять экземпляры, если среднее использование всех экземпляров меньше целевого использования.
* При принятии решений о масштабировании средство автоматического масштабирования игнорирует данные об использовании экземпляров, которые все еще находятся в периоде охлаждения.
* Если вы включаете прогнозирующий режим, период охлаждения сообщает прогнозирующему автомасштаберу о дальнейшем масштабировании до ожидаемой нагрузки, чтобы приложения инициализировались при поступлении нагрузки. Например, если вы установите период охлаждения равным 300 секундам, то прогностический автоскалер создаст виртуальные машины на 5 минут раньше прогнозируемой загрузки.

Укажите период охлаждения, чтобы указать, сколько времени требуется приложениям на вашем экземпляре для инициализации. По умолчанию период охлаждения составляет 60 секунд.

Фактическое время инициализации варьируется в зависимости от множества факторов. Мы рекомендуем вам проверить, сколько времени требуется для инициализации вашего приложения. Для этого создайте экземпляр и рассчитайте время запуска с момента запуска экземпляра до тех пор, пока приложение не будет готово.

Если вы зададите значение периода охлаждения, которое значительно превышает время, необходимое для инициализации экземпляра, то ваш авторазмер может игнорировать допустимые данные об использовании и может недооценить требуемый размер вашей группы, что приведет к задержке масштабирования.

Период стабилизации
"""""""""""""""""""

Для целей масштабирования автоскалер вычисляет рекомендуемый целевой размер группы на основе пиковой нагрузки за последние 10 минут. Эти последние 10 минут называются периодом стабилизации.

Используя период стабилизации, автоматическое масштабирование гарантирует, что рекомендуемого размера для вашей группы управляемых экземпляров всегда будет достаточно для обслуживания пиковой нагрузки, наблюдавшейся в течение предыдущих 10 минут.

Этот 10-минутный период стабилизации может показаться задержкой при масштабировании, но на самом деле это встроенная функция автоматического масштабирования. Задержка гарантирует, что меньшего размера группы будет достаточно для поддержки пиковой нагрузки за последние 10 минут.

Режим автоматического масштабирования
""""""""""""""""""""""""""""""""""""""

Если вам необходимо изучить или настроить свою группу без вмешательства операций автоматического масштабирования, вы можете временно отключить или ограничить действия по автоматическому масштабированию. Конфигурация автоматического масштабирования сохраняется, пока оно выключено или ограничено, и все действия по автоматическому масштабированию возобновляются, когда вы снова включаете его или снимаете ограничение.

Прогнозное автоматическое масштабирование
""""""""""""""""""""""""""""""""""""""""""""""" 

Если вы включите прогнозирующее автоматическое масштабирование для оптимизации MIG для обеспечения доступности, средство автоматического масштабирования прогнозирует будущую нагрузку на основе исторических данных и масштабирует MIG до прогнозируемой нагрузки, чтобы новые экземпляры были готовы к обслуживанию при поступлении нагрузки.

Прогнозное автоматическое масштабирование работает лучше всего, если ваша рабочая нагрузка соответствует следующим критериям:

* Инициализация вашего приложения занимает много времени — например, если вы настроили период охлаждения более 2 минут.
* Ваша рабочая нагрузка предсказуемо меняется в зависимости от ежедневных или еженедельных циклов.


Элементы управления масштабированием
"""""""""""""""""""""""""""""""""""""""

Если для инициализации ваших рабочих нагрузок требуется много минут (например, из-за длительных задач установки), вы можете снизить риск задержки ответа, вызванной внезапными событиями масштабирования, настроив элементы управления масштабированием. В частности, если вы ожидаете, что скачки нагрузки последуют вскоре после снижения, вы можете ограничить скорость масштабирования, чтобы предотвратить автоматическое масштабирование от уменьшения размера MIG на большее количество экземпляров виртуальной машины, чем может выдержать ваша рабочая нагрузка.

Вам не нужно настраивать элементы управления масштабированием, если ваше приложение инициализируется достаточно быстро, чтобы получать скачки нагрузки при масштабировании.

Чтобы настроить элементы управления масштабированием, задайте следующие свойства в политике автоматического масштабирования.

* Максимально допустимое снижение. Количество экземпляров виртуальной машины, которые ваша рабочая нагрузка может позволить себе потерять (из-за своего максимального размера) в течение указанного конечного временного окна. Используйте этот параметр, чтобы ограничить масштабирование вашей группы, чтобы вы все еще могли обслуживать вероятный скачок нагрузки, пока не начнут обслуживать больше экземпляров. Чем меньше вы установите максимально допустимое сокращение, тем больше времени потребуется для масштабирования вашей группы.

* Конечное временное окно. История, в рамках которой авторазмер отслеживает максимальный размер, необходимый для вашей рабочей нагрузки. Автоскалер не будет изменять размер ниже максимально допустимого уменьшения, вычитаемого из пикового размера, наблюдаемого в этот период. Вы можете использовать этот параметр, чтобы определить, как долго автоскалер должен ждать перед удалением экземпляров, как определено максимально допустимым уменьшением. При более длительном временном интервале автоскейлер учитывает больше исторических пиков, делая масштабирование более консервативным и стабильным.

Дополнительные сведения см. в разделе Настройка элементов управления масштабированием и Общие сведения о решениях по автоматическому масштабированию.

Рекомендуемый размер
"""""""""""""""""""""""""

Рекомендуемый размер группы - это рекомендуемое автомасштабером количество виртуальных машин, которое должна поддерживать группа управляемых экземпляров, на основе пиковой нагрузки, наблюдаемой в течение последних 10 минут. Эти последние 10 минут называются периодом стабилизации. Рекомендуемый размер постоянно пересчитывается. Если вы задаете политику автоматического масштабирования с элементами управления масштабированием, то рекомендуемый размер ограничивается вашими элементами управления масштабированием.

Ценообразование
""""""""""""""""""""""

Дополнительная плата за настройку политики автоматического масштабирования не взимается. Средство автоматического масштабирования динамически добавляет или удаляет экземпляры виртуальных машин, поэтому с вас взимается плата только за ресурсы, которые использует ваш MIG. Вы можете контролировать стоимость ресурсов, настраивая минимальное и максимальное количество экземпляров в политике автоматического масштабирования. 

Scaling based on CPU utilization 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Простейшей формой автоматического масштабирования является масштабирование группы управляемых экземпляров (MIG) на основе загрузки ЦП ее экземпляров.

Вы также можете масштабировать MIG на основе пропускной способности внешнего балансировщика нагрузки HTTP(S) или показателей мониторинга.

Масштабирование на основе загрузки ЦП
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Вы можете масштабировать автоматически на основе средней загрузки ЦП группы управляемых экземпляров (MIG). Использование этой политики указывает авторазмер для сбора загрузки ЦП экземпляров в группе и определения необходимости масштабирования. Вы устанавливаете целевую загрузку ЦП, которую должен поддерживать автоскалер, и автоскалер работает для поддержания этого уровня.

Средство автоматического масштабирования обрабатывает целевой уровень загрузки ЦП как долю от среднего использования всех vCPU с течением времени в группе экземпляров. Если среднее использование общего числа VCPU превышает целевое использование, средство автоматического масштабирования добавляет больше экземпляров виртуальных машин. Если среднее использование ваших общих VCPU меньше целевого использования, средство автоматического масштабирования удаляет экземпляры. Например, установка целевого показателя использования 0,75 указывает автомасштаберу поддерживать среднее значение использования 75% среди всех VCPU в группе экземпляров.

Вы также можете масштабировать на основе прогнозируемой загрузки процессора. Дополнительные сведения и сведения о том, подходит ли это для вашей рабочей нагрузки, см. в разделе Использование прогнозирующего автоматического масштабирования.

Enable autoscaling based on CPU utilization
""""""""""""""""""""""""""""""""""""""""""""""

.. figure:: autoscalecpu.png
	:scale: 100%
	:align: center
	






